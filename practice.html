<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hour-wise Attendance</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-3">Scan Attendance</h2>
    <div id="reader" style="width:500px;"></div>

    <h2 class="mt-5">Today's Attendance</h2>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Time</th>
                <th>Hour</th>
            </tr>
        </thead>
        <tbody id="t_body"></tbody>
    </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot,collectionGroup, getDocs, doc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { listCollections } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDXYuGsHV-u8HzDbBCrLDJAhTAYdSDjI8Q",
  authDomain: "attendence-bc81d.firebaseapp.com",
  projectId: "attendence-bc81d",
  storageBucket: "attendence-bc81d.firebasestorage.app",
  messagingSenderId: "804910602579",
  appId: "1:804910602579:web:eb61bbb3a2c6b1ef1229a6",
  measurementId: "G-CBCKQTJ9ZM"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== QR SCANNER =====



let html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    { fps: 10, qrbox: {width:250, height:250} },
    false
);

function onScanSuccess(decodedResult){
    const res = JSON.parse(decodedResult);
  console.log(res);
  

    // addDoc(collection(db, "Attendance", {
    //     name: res.studentName,
    //     studentID: res.studentId,
    //     Time: Date.toString()
    // }).then(() => {
    //     console.log("Attendance added:", res);
    // }).catch(err => console.log(err)))

    // html5QrcodeScanner.pause(true);
    // setTimeout(() => html5QrcodeScanner.resume(), 3000);
}

function onScanFailure(error){
    console.log(error);
    
}

// Start scanner
html5QrcodeScanner.render(onScanSuccess, onScanFailure);

// ===== DISPLAY ALL HOURS ATTENDANCE =====
const t_body = document.getElementById("t_body");
async function getAllDaySubcollections() {
  console.log("üîç Fetching all subcollections under /Attendance/day ...");

  try {
    // ‚úÖ Step 1: Reference to document /Attendance/day
    const dayDocRef = doc(db, "Attendance", "day");

    // ‚úÖ Step 2: List all subcollections (like 15, 16, 17...)
    const subcollections = await listCollections(dayDocRef);

    if (subcollections.length === 0) {
      console.warn("‚ö†Ô∏è No subcollections found under /Attendance/day");
      return;
    }

    // ‚úÖ Step 3: Loop through each subcollection and log documents
    for (const subcol of subcollections) {
      console.log(`üìÅ Found subcollection: ${subcol.id}`);

      const snapshot = await getDocs(subcol);
      snapshot.forEach((docSnap) => {
        console.log(`üìò [Day: ${subcol.id}] -> ${docSnap.id}`, docSnap.data());
      });
    }
  } catch (error) {
    console.error("‚ùå Error fetching data:", error);
  }
}

getAllDaySubcollections();

</script>
</body>
</html>
